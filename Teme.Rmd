---
title: "Tematska mapa HNB u digitalnom medijskom prostoru u RH"
author: "Lux"
date: "20. kolovoza 2025."
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide 
---

```{r setup, include=FALSE}
# --- Globalne postavke za R Markdown dokument ---
knitr::opts_chunk$set(
  echo = FALSE,       # Skriva kod
  message = FALSE,    # Skriva poruke
  warning = FALSE,    # Skriva upozorenja
  fig.width = 12,     # Širina slika
  fig.height = 7,     # Visina slika
  dpi = 200           # Visoka rezolucija slika
)
```

```{r libraries, include=FALSE}
# --- Učitavanje svih potrebnih paketa na jednom mjestu ---
library(scales)
library(patchwork)
library(ggrepel)
library(udpipe)
library(dplyr)
library(tidytext)
library(stringr)
library(ggplot2)
library(forcats)
library(tidyr)
library(ggridges)
library(widyr)
library(ggraph)
library(igraph)
library(wordcloud)
library(RColorBrewer)
```

```{r data-preparation, include=FALSE}
# --- Priprema podataka (izvršava se u pozadini) ---

# Učitavanje glavne baze podataka
# remove titkok from SOURCE_TYPE
dta <- readRDS("./hnb.rds") %>%
  mutate(
    DATE = as.Date(DATE), # Convert the column to Date class first
    year = as.integer(format(DATE, "%Y"))
  ) %>%
  filter(SOURCE_TYPE != "tiktok") %>%
  mutate(
    SOURCE_TYPE = factor(SOURCE_TYPE, levels = c("web", "youtube", "facebook", "twitter", "reddit", "forum", "comment"))
  ) %>%
  #remove year 2024
  filter(DATE >= as.Date("2021-01-01") & DATE < as.Date("2024-01-01")) %>%
  filter(year != 2024) %>%
  mutate(doc_id = row_number())



# Kreiranje stratificiranog uzorka
# sample_proportion <- 0.05
# set.seed(123)
# dta_stratified_sample <- dta %>%
#   filter(nchar(FULL_TEXT) > 100) %>%
#   group_by(year, SOURCE_TYPE) %>%
#   slice_sample(prop = sample_proportion) %>%
#   ungroup() %>%
#   mutate(doc_id = row_number())

# Učitavanje prethodno obrađenih lingvističkih podataka (štedi vrijeme)
files <- list.files("D:/LUKA/HNB/Language model sample", full.names = TRUE, pattern = "\\.rds")
nlp_results_df <- lapply(files, readRDS) %>%
  bind_rows() %>%
  mutate(doc_id = as.integer(doc_id))

# Definicija tematskih rječnika v3
thematic_dictionaries_v3 <- list(
  
  # 1. Glavna funkcija HNB-a: kontrola cijena i novčane mase
  MONETARNA_POLITIKA_I_INFLACIJA = sort(c(
    "agregat", "cijen", "ciljan", "deflacij", "dezinflacij", "eskontn", 
    "ekspanzivn", "hro", "inflacij", "kamatn", "kamatna stopa", "kreditni plasmani", 
    "likvidnost", "mas", "monetarn", "novčan", "obvezna pričuva", "otvoreno tržište",
    "ponud", "potražnj", "referentn", "repo", "restriktivn", "stabilnost cijena", 
    "stop", "transmisijsk"
  )),
  
  # 2. Druga glavna funkcija: nadzor banaka i osiguranje zdravlja financijskog sustava
  FINANCIJSKA_STABILNOST_I_NADZOR_BANAKA = sort(c(
    "adekvatnost kapitala", "aml", "bank", "basel", "bonitet", "depozit", "financijsk", 
    "hanfa", "institucij", "kapitalni zahtjev", "kreditn", "leasing", "likvidacij",
    "loš kredit", "makrobonitetn", "nadzor", "nenaplativ", "npl", "osiguranje", 
    "osiguranje depozita", "regulacij", "rizik", "sanacij", "sistemsk",
    "sprečavanje pranja novca", "stabilnost", "stečaj", "stres test", "supervizij"
  )),
  
  # 3. Ključna tema u promatranom razdoblju
  UVODJENJE_EURA_I_TECAJ = sort(c(
    "aprecijacij", "cent", "deprecijacij", "devizn", "devizni tečaj", "dvostruki optjecaj", 
    "erm ii", "eur", "eurozon", "eurosustav", "fiksni tečaj", "konverzij", "kovnica novca",
    "kuna", "lipa", "prilagodb", "tečaj", "uvođenj", "zamjen", "zaokruživanj"
  )),
  
  # 4. HNB kao analitička institucija koja objavljuje projekcije za gospodarstvo
  MAKROEKONOMSKE_ANALIZE_I_PROGNOZE = sort(c(
    "analiz", "bdp", "bilten", "dug", "ekonomsk", "fiskaln", "gospodarsk", 
    "industrijska proizvodnja", "investicij", "izvoz", "izvješć", "javni dug", 
    "konkurentnost", "kretanj", "makroekonomsk", "nezaposlenost", "očekivanj", 
    "potrošnj", "prognoz", "projekcij", "rast", "recesij", "uvoz", "zaposlenost"
  )),
  
  # 5. Funkcioniranje same institucije, njezinih tijela i transparentnost
  UPRAVLJANJE_I_TRANSPARENTNOST_HNB = sort(c(
    "devizne pričuve", "dobit", "guverner", "gubitak", "hnb", "izvješće saboru", 
    "mandat", "neovisnost", "odluk", "pričuv", "proračun hnb", "revizij", "savjet hnb",
    "sjednic", "statut", "transparentnost", "viceguverner", "zakon o hnb", "zlato", 
    "zlatne rezerve"
  )),
  
  # 6. Upravljanje fizičkim i digitalnim novcem te platnim sustavima
  PLATNI_PROMET_I_GOTOVINA = sort(c(
    "beskontaktn", "cbdc", "digitalna valuta", "digitalni euro", "digitalni novac", 
    "fintech", "gotovin", "gotovinsk", "kartic", "kovanic", "kriptovalut", "nks", 
    "novčanic", "platni promet", "target2", "transakcij"
  )),
  
  # 7. Odnosi s ključnim međunarodnim financijskim institucijama
  MEDJUNARODNI_ODNOSI_I_EU = sort(c(
    "banka za međunarodne namire", "bis", "članstv", "ebrd", "ecb", "esb", 
    "europska komisija", "europska središnja banka", "europsk", "fitch", "imf", 
    "kreditni rejting", "mmf", "moody's", "s&p", "suradnj", "svjetska banka"
  )),
  
  # 8. Teme koje izazivaju javnu polemiku i kritike na račun HNB-a
  JAVNA_PERCEPCIJA_I_KRITIKE = sort(c(
    "afer", "dužnic", "etika", "franak", "klub", "kritik", "netransparentnost",
    "odgovornost", "plać", "polemik", "potrošač", "povjerenj", "presud", "skandal",
    "sukob interesa", "švicarac", "troškov", "tužb", "udruga franak", "zaštita potrošača"
  ))
)


hnb_duznosnici_dict <- list(
  HNB_DUZNOSNICI = c(
    # Sadašnji i nedavni čelnici
    "boris vujčić", "vujčić",
    "sandra švaljek", "švaljek",
    "tomislav ćorić", "ćorić",
    "michael faulend", "faulend",
    "bojan fras", "fras",
    "ivana jakir-bajo", "martina jakir-bajo", "jakir-bajo", "jakir", # Uključene obje verzije imena
    "maroje lang", "lang",
    "roman šubić", "šubić",
    "slavko tešija", "tešija",
    "martina drvar", "drvar",
    
    # Bivši guverneri
    "željko rohatinski", "rohatinski",
    "marko škreb", "škreb",
    
    # Povezani stručnjaci iz HNB-a
    "evan kraft", "kraft" # bivši savjetnik
  )
)

# ===================================================================
# 2. POLITIČKI AKTERI (VLADA I PREDSJEDNIK)
# ===================================================================
politicki_akteri_dict <- list(
  POLITICKI_AKTERI = c(
    "andrej plenković", "plenković",
    "zoran milanović", "milanović",
    "davor škrlec", "škrlec" # Bivši EU zastupnik, čest kritičar
  )
)

# ===================================================================
# 3. NEOVISNI ANALITIČARI, AKADEMICI I NOVINARI
# ===================================================================
analiticari_i_mediji_dict <- list(
  ANALITICARI_I_MEDIJI = c(
    # Ekonomski analitičari i profesori
    "velimir šonje", "šonje",
    "ljubo jurčić", "jurčić",
    "ivo družić", "družić",
    
    # Specijalizirani novinari
    "marina klepo", "klepo",
    "boris pavković", "pavković"
  )
)

# ===================================================================
# 4. ČELNICI DRUGIH FINANCIJSKIH INSTITUCIJA
# ===================================================================
financijske_institucije_dict <- list(
  FINANCIJSKE_INSTITUCIJE = c(
    # HANFA
    "ante žigman", "žigman", # sadašnji predsjednik
    "ante matek", "matek",   # bivši predsjednik
    
    # HUB (Hrvatska udruga banaka)
    "tamara perko", "perko", # sadašnja predsjednica
    "zdenko rogić", "rogić", # bivši predsjednik
    
    # HBOR
    "miroslav gržetić", "gržetić"
  )
)

# ===================================================================
# 5. MEĐUNARODNI DUŽNOSNICI (ECB, MMF)
# ===================================================================
medjunarodni_duznosnici_dict <- list(
  MEDJUNARODNI_DUZNOSNICI = c(
    # ECB
    "christine lagarde", "lagarde",
    "mario draghi", "draghi",
    
    # MMF
    "jan kees martijn", "martijn",
    "hans-jörg rudloff", "rudloff" # Napomena: Rudloff je bio predstavnik investicijske banke, ne MMF-a
  )
)

# ===================================================================
# 6. SINDIKALNI I DRUGI PREDSTAVNICI
# ===================================================================
sindikati_i_drugi_dict <- list(
  SINDIKATI_I_DRUGI = c(
    "krešimir sever", "sever",
    "mladen novosel", "novosel"
  )
)



svi_ljudi_dictionary <- c(
  hnb_duznosnici_dict,
  politicki_akteri_dict,
  analiticari_i_mediji_dict,
  financijske_institucije_dict,
  medjunarodni_duznosnici_dict,
  sindikati_i_drugi_dict
)

# Kombiniranje s glavnim tematskim rječnikom
#final_dictionary <- c(hnb_thematic_dictionary_v2, svi_ljudi_dictionary)









# Izračun tematskih scoreova i obogaćivanje baze podataka
calculate_theme_scores <- function(text, dictionaries) {
  text_lower <- tolower(text)
  total_words <- str_count(text_lower, "\\w+")
  if (total_words == 0) return(NULL)
  scores <- purrr::map(dictionaries, ~sum(str_count(text_lower, .x)))
  normalized_scores <- purrr::map(scores, ~(.x / total_words) * 1000)
  names(normalized_scores) <- paste0("norm_", names(scores))
  scores_vec <- unlist(scores)
  if(all(scores_vec == 0)){
    dominant_topic <- "Nema Teme"
  } else {
    dominant_topic <- names(scores)[which.max(scores_vec)]
  }
  return(c(as.list(scores), as.list(normalized_scores), dominant_topic = dominant_topic))
}
theme_analysis_data <- purrr::map_dfr(dta$FULL_TEXT, ~calculate_theme_scores(., thematic_dictionaries_v3))
dta_enriched <- bind_cols(dta, theme_analysis_data)
dta_with_themes <- bind_cols(dta, theme_analysis_data)



theme_analysis_data2 <- purrr::map_dfr(dta$FULL_TEXT, ~calculate_theme_scores(., svi_ljudi_dictionary))
dta_enriched2 <- bind_cols(dta, theme_analysis_data2)
dta_with_themes2 <- bind_cols(dta, theme_analysis_data2)



```


### Uvod: O čemu se govori?

Nakon mapiranja ključnih aktera i platformi u  prvoj analizi, ovaj izvještaj zaranja dublje u sadržaj digitalnog diskursa o Hrvatskoj narodnoj banci. Koristeći metode obrade prirodnog jezika (NLP) na cjelokupnom korpusu od preko 250.000 medijskih objava, prelazimo s pitanja tko i gdje na pitanje: o čemu se govori?

Cilj je stvoriti "anatomiju diskursa" u tri ključna smjera:
<br>

 -> Identificirati glavne teme koje oblikuju raspravu o HNB-u.

 -> Izmjeriti njihov intenzitet i utjecaj na angažman publike.

 -> Otkriti kako se teme međusobno povezuju i kako se njihov fokus mijenja kroz vrijeme.

Aanaliza koristi vođeni pristup tematskom modeliranju, gdje smo na temelju ekonomske i financijske ekspertize definirali ključne tematske kategorije, omogućujući preciznu i interpretativnu klasifikaciju sadržaja.

### Vizualni sažetak korpusa

Prije detaljnije analize,pogledajmo oblak 150 najčešćih, smislenih riječi (imenica, pridjeva i glagola) u cjelokupnom korpusu. Veličina svake riječi proporcionalna je njenoj ukupnoj frekvenciji.

Ovaj vizualni sažetak odmah otkriva ključne entitete i koncepte koji čine srž diskursa: HNB, guverner, banka, euro, inflacija, kamatna stopa, Vujčić, gospodarstvo i cijena.

```{r plot-wordcloud, fig.height=8, fig.width=12}
# 1. Priprema teksta: Lematizacija i uklanjanje zaustavnih riječi
# Učitajmo standardne hrvatske zaustavne riječi (možete ih naći online ili napraviti svoju listu)
stop_words_hr <- tibble(word = c(
  # Originalna lista
  "i", "u", "je", "na", "se", "su", "s", "za", "od", "o", "a", "te", "koji", "koja", "koje", "ga", "mu", "joj", "smo", "kao",

  # Prijedlozi (Prepositions)
  "bez", "blizu", "do", "duž", "ispred", "iza", "između", "iznad", "izvan", "k", "kod", "kraj", "mimo", "na", "nad", "nakon", "niže", "o", "od", "oko", "osim", "po", "pod", "pokraj", "poput", "pored", "poslije", "povrh", "preko", "prema", "pri", "prije", "protiv", "put", "radi", "s", "sa", "skupa", "tijekom", "u", "unatoč", "unutar", "usprkos", "uz", "van", "više", "zaradi", "zbog",

  # Veznici (Conjunctions)
  "a", "ali", "ama", "bilo", "da", "dakle", "dok", "eda", "i", "ili", "inače", "jer", "kad", "kako", "li", "makar", "mada", "nego", "negoli", "no", "pa", "pak", "premda", "samo", "što", "te", "ter", "već", "zatim", "zato",

  # Zamjenice (Pronouns)
  "ja", "ti", "on", "ona", "ono", "mi", "vi", "oni", "one", "ona", "sebe", "svoj", "moj", "tvoj", "njegov", "njezin", "naš", "vaš", "njihov", "ovaj", "ova", "ovo", "taj", "ta", "to", "onaj", "ona", "ono", "koji", "koja", "koje", "čiji", "čija", "čije", "kakav", "kakva", "kakvo", "kolik", "kolika", "koliko", "tko", "što", "nitko", "ništa", "itko", "išta", "svatko", "svašta", "netko", "nešto", "svakakav", "nikakav", "ikakav", "nekakav",

  # Čestice (Particles)
  "da", "ne", "li", "zar", "čak", "dapače", "evo", "eto", "eno", "gle", "god", "pak", "samo", "valjda", "vjerojatno", "zaista",

  # Prilozi (Adverbs)
  "gdje", "kamo", "kuda", "otkud", "odakle", "dokle", "ovdje", "ondje", "onamo", "ovamo", "ovuda", "onuda", "tada", "sada", "onda", "nikada", "nekada", "ponekad", "često", "rijetko", "uvijek", "stalno", "povremeno", "danas", "sutra", "jučer", "preksutra", "prekjučer", "lani", "zimus", "ljetos", "proljetos", "jesenas", "kako", "tako", "nikako", "nekako", "ovako", "onako", "zašto", "zato", "stoga", "koliko", "toliko", "ovoliko", "onoliko", "malo", "puno", "mnogo", "više", "manje", "najviše", "najmanje", "brzo", "sporo", "dobro", "loše", "jako", "slabo", "vrlo", "prilično", "sasvim", "gotovo", "jedva",

  # Pomoćni glagoli (Auxiliary Verbs)
  "biti", "jesam", "jesi", "jest", "jesmo", "jeste", "jesu", "bih", "bi", "bismo", "biste", "biše", "ću", "ćeš", "će", "ćemo", "ćete", "hoću", "hoćeš", "hoće", "hoćemo", "hoćete", "htjeti", "imam", "imaš", "ima", "imamo", "imate", "imaju", "imati", "nemam", "nemaš", "nema", "nemamo", "nemate", "nemaju", "nemati",

  # Česti glagoli (Common Verbs)
  "ići", "doći", "otići", "reći", "kazati", "govoriti", "pitati", "odgovoriti", "vidjeti", "gledati", "znati", "misliti", "moći", "morati", "trebati", "željeti", "htjeti", "dati", "uzeti", "napraviti", "raditi", "živjeti", "umrijeti", "roditi", "stajati", "sjediti", "ležati", "postati", "ostati", "nalaziti",

  # Česte imenice (Common Nouns)
  "stvar", "dio", "godina", "dan", "vrijeme", "čovjek", "ljudi", "žena", "muškarac", "dijete", "život", "svijet", "zemlja", "grad", "kuća", "posao", "ruka", "noga", "oko", "glava", "srce", "broj", "primjer", "način", "pitanje", "odgovor", "početak", "kraj", "strana", "slučaj",

  # Česti pridjevi (Common Adjectives)
  "velik", "malen", "dobar", "loš", "nov", "star", "lijep", "ružan", "visok", "nizak", "mlad", "star", "jak", "slab", "brz", "spor", "topao", "hladan", "pun", "prazan", "lak", "težak", "isti", "drugi", "različit", "jednostavan", "složen", "moguć", "nemoguć", "poznat", "nepoznat", "pravi", "krivi",

  # Česte imenice (Common Verbs)
  "godina", "moći"
  
  
))

# Naša inovacija: Prilagođena lista religijskih zaustavnih riječi
custom_stop_words <- tibble(word = c(
  # Originalna lista
  "bog", "isus", "gospodin", "moliti", "molitva", "amen",

  # Kršćanstvo (Christianity) - Općenito
  "krist", "biblija", "sveto pismo", "evanđelje", "crkva", "vjera", "vjernik", "grijeh", "pokajanje", "spasenje", "uskrsnuće", "krštenje", "euharistija", "sakrament", "apostol", "prorok", "svetac", "anđeo", "đavao", "sotona", "raj", "pakao", "čistilište", "milost", "blagoslov", "žrtva", "otkupljenje", "trojstvo", "duh sveti", "gospa", "djevica marija", "molitva", "post", "hodočašće", "župa", "župnik", "biskup", "kardinal", "papa", "pastir", "stado", "jaganjac božji",

  # Katolicizam (Catholicism)
  "katolički", "rimokatolički", "sveta stolica", "vatikan", "krunica", "misa", "ispovijed", "pričest", "krizma", "blaženi", "sveti", "nadbiskup", "opat", "časna sestra", "fratar", "svećenik", "kapelan", "celibat", "enciklika", "koncil",

  # Pravoslavlje (Orthodoxy)
  "pravoslavni", "patrijarh", "episkop", "mitropolit", "ikona", "ikonostas", "liturgija", "pričešće", "krst", "slava", "parohija", "paroh", "manastir", "iguman", "monah", "pravoslavlje",

  # Protestantizam (Protestantism)
  "protestantski", "evangelički", "reformacija", "luteran", "kalvinist", "baptist", "pentekostalac", "adventist", "pastor", "prezbiter", "đakon", "propovijed", "slavljenje",

  # Islam
  "islam", "musliman", "kur'an", "muhamed", "alah", "džamija", "minaret", "imam", "hodža", "efendija", "ramazan", "bajram", "hadž", "meka", "medina", "šerijat", "suniti", "šijiti", "džihad", "halal", "haram", "salat", "zekat", "šehadet",

  # Judaizam (Judaism)
  "judaizam", "židov", "tora", "talmud", "sinagoga", "rabin", "košer", "šabat", "pasha", "jom kipur", "roš hašana", "hanuka", "menora", "jahve", "adonaj",

  # Budizam (Buddhism)
  "budizam", "buda", "dharma", "sangha", "karma", "nirvana", "reinkarnacija", "meditacija", "zen", "dalaj lama", "sutre", "mantra", "stupa", "bodisatva",

  # Hinduizam (Hinduism)
  "hinduizam", "hindus", "vede", "upanišade", "bhagavad gita", "brahma", "višnu", "šiva", "krišna", "rama", "šakti", "ganeša", "guru", "svami", "ašram", "joga", "mokša", "samsara", "pudža",

  # Opći religijski i duhovni pojmovi (General Religious and Spiritual Terms)
  "religija", "duhovnost", "božanstvo", "božica", "mitologija", "obred", "ritual", "hram", "svetište", "oltar", "proročanstvo", "otkrivenje", "sudnji dan", "eshatologija", "teologija", "filozofija", "etika", "moral", "duša", "duh", "zagrobni život", "vječnost", "stvaranje", "stvoritelj", "prosvjetljenje", "spoznaja", "transcendencija", "imanencija", "sveto", "profano", "hereza", "sekta", "kult"
))



# Kombiniramo liste
all_stop_words <- bind_rows(stop_words_hr, custom_stop_words)

words_to_remove <- c("godina", "moći") # Dodajte ovdje svoje riječi

word_freq_for_cloud <- nlp_results_df %>%
  filter(upos %in% c("NOUN", "ADJ", "VERB")) %>%
  filter(!lemma %in% stop_words_hr) %>% # Uklanjanje općih stop-riječi
  filter(!lemma %in% words_to_remove) %>% # Uklanjanje vaših specifičnih riječi
  count(lemma, sort = TRUE)




# 2. Kreiranje vizualizacije s ggwordcloud
#set.seed(123) # Za reproduktivnost izgleda oblaka
wordcloud(
  words = word_freq_for_cloud$lemma,    # Riječi
  freq = word_freq_for_cloud$n,         # Frekvencije
  min.freq = 50,                        # Prikazuj samo riječi koje se pojave bar 50 puta
  max.words = 100,                      # Maksimalan broj riječi za prikaz
  random.order = FALSE,                 # Najčešće riječi idu u centar
  rot.per = 0.30,                       # Postotak riječi koje će biti rotirane
  colors = brewer.pal(8, "Dark2")       # Paleta boja
)

# Dodajemo naslo

```


---

# I.Pregled tematskog pejzaža

Prvi korak je razumjeti opću strukturu diskursa. Koje teme dominiraju, a koje su na marginama? Koliko su te teme centralne za članke u kojima se pojavljuju?

### Dinamika glavnih tema 

Analiza udjela svake teme u ukupnom broju spominjanja otkriva stabilnu strukturu, ali i značajne promjene potaknute ključnim događajima. Očekivano, teme vezane za Monetarnu politiku i inflaciju te Financijsku stabilnost čine okosnicu diskursa. Značajan udio zauzima i tema Uvođenja eura, čiji je vrhunac vidljiv tijekom 2022. godine, dok teme vezane za Javnu percepciju i kritike također imaju konstantan i zamjetan udio.

```{r plot-topic-trends}


topic_trends_guided <- dta_with_themes %>%
  select(year, MONETARNA_POLITIKA_I_INFLACIJA:JAVNA_PERCEPCIJA_I_KRITIKE) %>%
  pivot_longer(cols = -year, names_to = "topic", values_to = "count") %>%
  group_by(year, topic) %>%
  summarise(total_mentions = sum(count), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(share = total_mentions / sum(total_mentions)) %>%
  ungroup() %>%
  group_by(topic) %>%
  filter(any(share >= 0.05)) %>%
  ungroup()

ggplot(topic_trends_guided, aes(x = year, y = share, color = topic, group = topic)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = c(2021, 2022, 2023)) +
  labs(title = "Promjena zastupljenosti glavnih tema (iznad 5% udjela)",
       x = "Godina", y = "Udio teme u korpusu svih tekstova", color = "Tema") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")
```


```{r}

topic_trends_guided2 <- dta_with_themes2 %>%
  select(year, HNB_DUZNOSNICI:SINDIKATI_I_DRUGI) %>%
  pivot_longer(cols = -year, names_to = "topic", values_to = "count") %>%
  group_by(year, topic) %>%
  summarise(total_mentions = sum(count), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(share = total_mentions / sum(total_mentions)) %>%
  ungroup() %>%
  group_by(topic) %>%
  filter(any(share >= 0.05)) %>%
  ungroup()

ggplot(topic_trends_guided2, aes(x = year, y = share, color = topic, group = topic)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = c(2021, 2022, 2023)) +
  labs(title = "Promjena zastupljenosti glavnih tema (iznad 5% udjela)",
       x = "Godina", y = "Udio teme u korpusu svih tekstova", color = "Tema") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "bottom")
```


### Intenzitet tema: Što je vijest, a što pozadinski šum?

Nije svako spominjanje teme jednako važno. Ovaj grafikon pokazuje koliko je tema centralna za članak kada se u njemu pojavi. Teme s distribucijom pomaknutom udesno (npr. Monetarna politika) su one koje, kada se pojave, dominiraju člankom i predstavljaju glavnu vijest. Teme s distribucijom bliže lijevoj strani (npr. Međunarodni odnosi) češće se spominju usputno, kao kontekst glavne priče.

```{r plot-topic-intensity}
thematic_intensity_data <- dta_enriched %>%
  select(starts_with("norm_")) %>%
  pivot_longer(everything(), names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0)

ggplot(thematic_intensity_data, aes(x = intensity, y = fct_reorder(topic, intensity, .fun = median))) +
  geom_density_ridges(scale = 2, fill = "#0072B2", color = "white", alpha = 0.8) +
  scale_x_log10(breaks = c(1, 10, 100, 1000), labels = c("1", "10", "100", "1000")) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Distribucija intenziteta tema",
    subtitle = "Koliko su teme centralne za članke u kojima se pojavljuju?",
    x = "Intenzitet teme (spominjanja na 1000 riječi, log skala)",
    y = "Tema"
  ) +
  theme(panel.grid.major.y = element_blank())
```



```{r}
thematic_intensity_data2 <- dta_enriched2 %>%
  select(starts_with("norm_")) %>%
  pivot_longer(everything(), names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0)

ggplot(thematic_intensity_data2, aes(x = intensity, y = fct_reorder(topic, intensity, .fun = median))) +
  geom_density_ridges(scale = 2, fill = "#0072B2", color = "white", alpha = 0.8) +
  scale_x_log10(breaks = c(1, 10, 100, 1000), labels = c("1", "10", "100", "1000")) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Distribucija intenziteta tema",
    subtitle = "Koliko su teme centralne za članke u kojima se pojavljuju?",
    x = "Intenzitet teme (spominjanja na 1000 riječi, log skala)",
    y = "Tema"
  ) +
  theme(panel.grid.major.y = element_blank())
```


# II.Utjecaj i prijem tema

Nakon što smo mapirali teme, istražujemo kako publika reagira na njih. Koje teme potiču najveći angažman, a koje najviše polariziraju?

### Koje teme generiraju najviše interakcija?

Analiza prosječnog broja interakcija po članku otkriva da teme koje se tiču Javne percepcije i kritika (posebno vezane uz afere ili slučaj "Franak") generiraju značajno veći angažman od stručnih tema vezanih za makroekonomske analize ili platni promet. Ovo ukazuje da konflikt i kontroverza služe kao ključni pokretači interakcija u digitalnom prostoru kada je riječ o HNB-u.

```{r plot-engagement-by-topic}
engagement_by_topic <- dta_enriched %>%
  filter(dominant_topic != "Nema Teme") %>%
  group_by(dominant_topic) %>%
  summarise(
    avg_interactions = mean(INTERACTIONS, na.rm = TRUE),
    total_articles = n()
  ) %>%
  arrange(desc(avg_interactions))

ggplot(engagement_by_topic, aes(x = avg_interactions, y = reorder(dominant_topic, avg_interactions))) +
  geom_col(fill = "#0072B2", width=0.8) +
  geom_text(aes(label = round(avg_interactions)), hjust = -0.2, size=4) +
  expand_limits(x = max(engagement_by_topic$avg_interactions) * 1.1) +
  theme_minimal(base_size = 14) +
  labs(title = "Koje teme generiraju najviše interakcija?",
       subtitle = "Prosječan broj interakcija po članku za svaku dominantnu temu",
       x = "Prosječne interakcije", y = "Dominantna tema") +
  theme(panel.grid.major.y = element_blank())
```




```{r}
engagement_by_topic2 <- dta_enriched2 %>%
  filter(dominant_topic != "Nema Teme") %>%
  group_by(dominant_topic) %>%
  summarise(
    avg_interactions = mean(INTERACTIONS, na.rm = TRUE),
    total_articles = n()
  ) %>%
  arrange(desc(avg_interactions))

ggplot(engagement_by_topic2, aes(x = avg_interactions, y = reorder(dominant_topic, avg_interactions))) +
  geom_col(fill = "#0072B2", width=0.8) +
  geom_text(aes(label = round(avg_interactions)), hjust = -0.2, size=4) +
  expand_limits(x = max(engagement_by_topic$avg_interactions) * 1.1) +
  theme_minimal(base_size = 14) +
  labs(title = "Koje teme generiraju najviše interakcija?",
       subtitle = "Prosječan broj interakcija po članku za svaku dominantnu temu",
       x = "Prosječne interakcije", y = "Dominantna tema") +
  theme(panel.grid.major.y = element_blank())
```






```{r plot-polarization-by-topic, eval= FALSE, fig.height=6, fig.width=10}
### Mapa emocija: Koje teme izazivaju ljubav, a koje ljutnju?

# Analizirajući Facebook reakcije, možemo okvirno mapirati emocionalni odgovor na svaku temu. Rezultati su jasni: teme vezane za Financijsku stabilnost i uspješno Uvođenje eura dominantno izazivaju pozitivne ili neutralne reakcije. S druge strane, teme Javnih kritika i rasprave o Inflaciji generiraju najveći udio negativnih (Angry) reakcija, potvrđujući njihovu ulogu kao glavnih točaka polarizacije.


polarization_by_topic <- dta_enriched %>%
  filter(TOTAL_REACTIONS_COUNT > 1) %>%
  group_by(dominant_topic) %>%
  summarise(
    total_angry = sum(ANGRY_COUNT, na.rm = TRUE),
    total_love = sum(LOVE_COUNT, na.rm = TRUE),
    total_reactions = sum(TOTAL_REACTIONS_COUNT, na.rm = TRUE)
  ) %>%
  mutate(
    angry_ratio = total_angry / total_reactions,
    love_ratio = total_love / total_reactions
  ) %>%
  filter(total_reactions > 100) # Gledamo samo teme s dovoljno reakcija za analizu

ggplot(polarization_by_topic, aes(y = reorder(dominant_topic, angry_ratio))) +
  geom_col(aes(x = angry_ratio), fill = "firebrick", alpha = 0.8) +
  geom_col(aes(x = -love_ratio), fill = "steelblue", alpha = 0.8) +
  geom_vline(xintercept = 0, color="grey") +
  scale_x_continuous(labels = function(x) percent(abs(x)), name = "Udio u ukupnim reakcijama") +
  theme_minimal(base_size = 14) +
  labs(title = "Koje teme generiraju 'Ljubav', a koje 'Ljutnju'?",
       subtitle = "Plavo = udio 'Love' reakcija | Crveno = udio 'Angry' reakcija",
       y = "Dominantna tema")
```

---

# III.Akteri i narativni okviri

Tko su glavni protagonisti svake teme i kako se teme međusobno povezuju u šire narativne okvire? Ova sekcija spaja tematsku analizu s analizom aktera i mrežnom analizom.

### Glavni akteri unutar svake teme

Svaka tematska "priča" ima svoje glavne likove. Analizom najčešće spominjanih osoba unutar svake dominantne teme, dobivamo uvid u to tko su nositelji narativa. Očekivano, dužnosnici HNB-a dominiraju stručnim temama poput monetarne politike, dok politički akteri preuzimaju glavnu riječ u temama koje se tiču javnih kritika i percepcije.


```{r, fig.height=10}


# --- ANALIZA AKTERA U TOP 5 DOMINANTNIH TEMA ---

# 1. KORAK: Identificiramo kojih je 5 najčešćih dominantnih tema
top_5_dominant_topics <- dta_enriched %>%
  filter(dominant_topic != "Nema Teme") %>%
  count(dominant_topic, sort = TRUE) %>%
  slice_max(order_by = n, n = 5) %>%
  pull(dominant_topic) # 'pull' izvlači samo imena tema u vektor

# 2. KORAK: Priprema podataka ostaje ista, ali s dodatnim filterom
entities_in_topics <- nlp_results_df %>%
  filter(upos == "PROPN") %>%
  select(doc_id, lemma) %>%
  inner_join(dta_enriched %>% select(doc_id, dominant_topic), by = "doc_id") %>%
  filter(dominant_topic %in% top_5_dominant_topics) %>% # OVDJE JE FILTER!
  filter(!lemma %in% c("hrvatska", "OŽALOŠCENI", "bog", "isus", "zagreb", "split", "nedjelja", "crkva", "dalmacija"))

# 3. KORAK: Izračun top 6 aktera unutar tih 5 tema
top_actors_in_top_topics <- entities_in_topics %>%
  count(dominant_topic, lemma, sort = TRUE) %>%
  group_by(dominant_topic) %>%
  slice_max(order_by = n, n = 10) %>%
  ungroup()

# 4. KORAK: Poboljšana vizualizacija
ggplot(top_actors_in_top_topics, aes(x = n, y = reorder_within(lemma, n, dominant_topic), fill = dominant_topic)) +
  
  # Stupci ostaju isti
  geom_col(show.legend = FALSE, width = 0.8) +
  
  # UKLANJAMO 'geom_text' LINIJU - OVO JE KLJUČNA PROMJENA
  # geom_text(aes(label = n), hjust = -0.2, size = 3.5, color = "gray20") +
  
  # Ostatak koda ostaje isti
  scale_y_reordered() +
  scale_fill_viridis_d() +
  
  # Promijenili smo broj stupaca na 1 radi boljeg prikaza 5 tema
  facet_wrap(~ dominant_topic, scales = "free_y", ncol = 1) + 
  
  labs(
    title = "Ključni akteri unutar Top 5 najzastupljenijih tema",
    subtitle = "Top 6 najčešće spominjanih osoba ili organizacija za svaku temu",
    x = "Ukupan broj spominjanja", # Dodajemo x-os jer više nema tekstualnih oznaka
    y = "Akter (lema)"
  ) +
  
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 20, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 14, color = "gray40", margin = margin(b = 20)),
    strip.text = element_text(face = "bold", size = 12, hjust = 0),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "#f0f0f0"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  )
```



```{r, eval = FALSE}


# 1. KORAK: Identificiramo kojih je 5 najčešćih dominantnih tema
top_5_dominant_topics2 <- dta_enriched2 %>%
  filter(dominant_topic != "Nema Teme") %>%
  count(dominant_topic, sort = TRUE) %>%
  slice_max(order_by = n, n = 5) %>%
  pull(dominant_topic) # 'pull' izvlači samo imena tema u vektor

# 2. KORAK: Priprema podataka ostaje ista, ali s dodatnim filterom
entities_in_topics2 <- nlp_results_df %>%
  filter(upos == "PROPN") %>%
  select(doc_id, lemma) %>%
  inner_join(dta_enriched2 %>% select(doc_id, dominant_topic), by = "doc_id") %>%
  filter(dominant_topic %in% top_5_dominant_topics) # # OVDJE JE FILTER!
 # filter(!lemma %in% c("hrvatska", "OŽALOŠCENI", "bog", "isus", "zagreb", "split", "nedjelja", "crkva", "dalmacija"))

# 3. KORAK: Izračun top 6 aktera unutar tih 5 tema
top_actors_in_top_topics2 <- entities_in_topics2 %>%
  count(dominant_topic, lemma, sort = TRUE) %>%
  group_by(dominant_topic) %>%
  slice_max(order_by = n, n = 10) %>%
  ungroup()

# 4. KORAK: Poboljšana vizualizacija
ggplot(top_actors_in_top_topics2, aes(x = n, y = reorder_within(lemma, n, dominant_topic), fill = dominant_topic)) +
  
  # Stupci ostaju isti
  geom_col(show.legend = FALSE, width = 0.8) +
  
  # UKLANJAMO 'geom_text' LINIJU - OVO JE KLJUČNA PROMJENA
  # geom_text(aes(label = n), hjust = -0.2, size = 3.5, color = "gray20") +
  
  # Ostatak koda ostaje isti
  scale_y_reordered() +
  scale_fill_viridis_d() +
  
  # Promijenili smo broj stupaca na 1 radi boljeg prikaza 5 tema
  facet_wrap(~ dominant_topic, scales = "free_y", ncol = 1) + 
  
  labs(
    title = "Ključni akteri unutar Top 5 najzastupljenijih tema",
    subtitle = "Top 6 najčešće spominjanih osoba ili organizacija za svaku temu",
    x = "Ukupan broj spominjanja", # Dodajemo x-os jer više nema tekstualnih oznaka
    y = "Akter (lema)"
  ) +
  
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 20, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 14, color = "gray40", margin = margin(b = 20)),
    strip.text = element_text(face = "bold", size = 12, hjust = 0),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "#f0f0f0"),
    panel.grid.minor = element_blank(),
    plot.margin = margin(20, 20, 20, 20)
  )
```






### Mreža narativnih okvira: Kako se teme povezuju?

Teme se rijetko pojavljuju izolirano. One se spajaju u šire narativne okvire (frames). Analizom ko-okurencije tema unutar istih članaka, možemo mapirati te veze. Mreža pokazuje snažnu povezanost između Monetarne politike, Inflacije i Makroekonomskih analiza, tvoreći dominantan "stručno-ekonomski" klaster. S druge strane, teme poput Javne percepcije i kritika snažno su povezane s političkim akterima, čineći izražen "društveno-politički" klaster.

```{r plot-topic-network, fig.height=10}
# Ovaj kod je iz vašeg RMD-a, samo ga prikazujemo ovdje.
topic_pairs <- dta_enriched %>%
  select(doc_id, starts_with("norm_")) %>%
  pivot_longer(-doc_id, names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0) %>%
  pairwise_cor(item = topic, feature = doc_id, upper = FALSE)

set.seed(123)
topic_pairs %>%
  filter(correlation > 0.1) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(edge_alpha = correlation, edge_width = correlation), color = "lightblue") +
  geom_node_point(color = "darkblue", size = 5) +
  geom_node_text(aes(label = str_wrap(name, 20)), repel = TRUE, size = 4) +
  theme_void() +
  labs(
    title = "Mreža povezanosti tema",
    subtitle = "Koje se teme najčešće pojavljuju zajedno u istim člancima?",
    edge_width = "Snaga veze (korelacija)",
    edge_alpha = ""
  )
```



```{r , eval=FALSE}
# Ovaj kod je iz vašeg RMD-a, samo ga prikazujemo ovdje.
topic_pairs <- dta_enriched2 %>%
  select(doc_id, starts_with("norm_")) %>%
  pivot_longer(-doc_id, names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0) %>%
  pairwise_cor(item = topic, feature = doc_id, upper = FALSE)

set.seed(123)
topic_pairs %>%
  filter(correlation > 0.1) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(edge_alpha = correlation, edge_width = correlation), color = "lightblue") +
  geom_node_point(color = "darkblue", size = 5) +
  geom_node_text(aes(label = str_wrap(name, 20)), repel = TRUE, size = 4) +
  theme_void() +
  labs(
    title = "Mreža povezanosti tema",
    subtitle = "Koje se teme najčešće pojavljuju zajedno u istim člancima?",
    edge_width = "Snaga veze (korelacija)",
    edge_alpha = ""
  )
```




## Zaključak

Ova tematska analiza pokazuje da digitalni prostor o HNB-u nije monolitan. Sastoji se od različitih, često odvojenih, tematskih prostora. Eksperni prostor fokusiran je na monetarnu politiku, financijsku stabilnost i makroekonomske analize, s dominantno neutralnim i stručnim tonom.Javno-politički prostor: Gdje se teme uvođenja eura, utjecaja inflacije i javnih kritika isprepliću, generirajući najveći angažman, ali i najsnažniju polarizaciju.Razumijevanje strukture, utjecaja i povezanosti ovih tema ključno je za svaku daljnju analizu narativa i sentimenata koji oblikuju javnu percepciju Hrvatske narodne banke.
