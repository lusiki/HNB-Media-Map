---
title: "Tematska mapa HNB-a (Potrošačke Teme)"
author: "Lux"
date: "20. kolovoza 2025."
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide 
---

```{r setup, include=FALSE}
# --- Globalne postavke za R Markdown dokument ---
knitr::opts_chunk$set(
  echo = FALSE,      # Skriva kod
  message = FALSE,   # Skriva poruke
  warning = FALSE,   # Skriva upozorenja
  fig.width = 12,    # Širina slika
  fig.height = 7,    # Visina slika
  dpi = 200          # Visoka rezolucija slika
)
```


```{r}
# --- Učitavanje svih potrebnih paketa na jednom mjestu ---
library(scales)
library(patchwork)
library(ggrepel)
library(dplyr)
library(tidytext)
library(stringr)
library(ggplot2)
library(forcats)
library(tidyr)
library(ggridges)
library(widyr)
library(ggraph)
library(igraph)
library(wordcloud)
library(RColorBrewer)
```

```{r}
# --- Priprema podataka (izvršava se u pozadini) ---

# Učitavanje glavne baze podataka
dta <- readRDS("./hnb.rds") %>%
  mutate(
    DATE = as.Date(DATE), # Convert the column to Date class first
    year = as.integer(format(DATE, "%Y"))
  ) %>%
  filter(SOURCE_TYPE != "tiktok") %>%
  mutate(
    SOURCE_TYPE = factor(SOURCE_TYPE, levels = c("web", "youtube", "facebook", "twitter", "reddit", "forum", "comment"))
  ) %>%
  filter(DATE >= as.Date("2021-01-01") & DATE < as.Date("2024-01-01")) %>%
  filter(year != 2024) %>%
  mutate(doc_id = row_number())

# Učitavanje prethodno obrađenih lingvističkih podataka (štedi vrijeme)
# Prilagodite putanju do vaših .rds datoteka
files <- list.files("D:/LUKA/HNB/Language model sample", full.names = TRUE, pattern = "\\.rds")
nlp_results_df <- lapply(files, readRDS) %>%
  bind_rows() %>%
  mutate(doc_id = as.integer(doc_id))

# --- NOVI POTROŠAČKI RJEČNICI ---
hnb_consumer_topics_dictionary_final <- list(
  INTEREST_RATES = sort(unique(c(
    "cijena novca", "eskontna stopa", "euribor", "hlađenje tržišta", "kamata na kredite",
    "kamatna stopa", "kamatnjak", "ključna kamatna stopa", "nrs", 
    "posljedica za građane", "referentna stopa", "regulacija kamata",
    "politika kamatnih stopa", "transmisijski mehanizam", "utjecaj na kredite", 
    "utjecaj na kamate", "dizanje kamata", "kamata na štednju", "lombardna stopa", 
    "monetarna politika", "pad kamata", "povećanje kamata", "rast kamata", 
    "smanjenje kamata", "utjecaj na štednju"
  ))),
  LENDING_REGULATIONS = sort(unique(c(
    "dohodak", "dsti", "kreditna sposobnost", "makroprudencijalna mjera", 
    "mjere hnb-a", "ograničenje zaduživanja", "ograničenje kredita", "omjer duga",
    "regulacija zaduživanja", "supervizorska očekivanja", "uvjeti kreditiranja",
    "financijska stabilnost", "kreditni registar", "ltv", "omjer duga i dohotka",
    "omjer kredita i vrijednosti nekretnine", "prezaduženost"
  ))),
  BANK_FEES = sort(unique(c(
    "intervencija hnb-a", "kontrola naknada", "cijena usluga", "nadzor nad naknadama", 
    "naknada", "neopravdane naknade", "nepoštena praksa", "povećanje naknada",
    "pritužba potrošača", "provizija", "regulacija naknada", "skriveni troškovi",
    "zaštita potrošača", "zakon o platnom prometu", "bankovne naknade", 
    "naknada za obradu kredita", "naknada za vođenje računa", "transparentnost naknada", 
    "usporedivost naknada"
  ))),
  BASIC_BANK_ACCOUNT = sort(unique(c(
    "bez naknade", "besplatan račun", "osnovni račun", "osnovni račun za plaćanje",
    "ranjive skupine", "socijalni paket", "zakonska obveza", 
    "direktiva o računima za plaćanje", "pravo na osnovni račun"
  ))),
  CONSUMER_PROTECTION = sort(c(
    "edukacija hnb", "financijska pismenost", "medijacija", "mirenje",
    "nepoštena poslovna praksa", "potrošački spor", "prigovor na banku", 
    "pritužba hnb-u", "zaštita potrošača"
  )),
  HNB_INTERNAL_AFFAIRS = sort(unique(c(
    "bonusi u hnb", "guvernerova plaća", "materijalna prava", "plaća", "plaće u hnb-u",
    "povećanje plaće", "primanja dužnosnika", "prosječna plaća hnb", "revizija poslovanja",
    "troškovi osoblja hnb", "plaća u hnb-u", "plaće dužnosnika", "primanja u hnb-u", 
    "revizija poslovanja hnb", "troškovi poslovanja hnb", "plaća viceguvernera"
  )))
)

# Izračun tematskih scoreova i obogaćivanje baze podataka
calculate_theme_scores <- function(text, dictionaries) {
  text_lower <- tolower(text)
  total_words <- str_count(text_lower, "\\w+")
  if (total_words == 0) return(NULL)
  scores <- purrr::map(dictionaries, ~sum(str_count(text_lower, .x)))
  normalized_scores <- purrr::map(scores, ~(.x / total_words) * 1000)
  names(normalized_scores) <- paste0("norm_", names(scores))
  scores_vec <- unlist(scores)
  if(all(scores_vec == 0)){
    dominant_topic <- "Nema Teme"
  } else {
    dominant_topic <- names(scores)[which.max(scores_vec)]
  }
  return(c(as.list(scores), as.list(normalized_scores), dominant_topic = dominant_topic))
}

# Primjena funkcije s novim, potrošačkim rječnicima
theme_analysis_data_consumer <- purrr::map_dfr(dta$FULL_TEXT, ~calculate_theme_scores(., hnb_consumer_topics_dictionary_final))
dta_with_consumer_themes <- bind_cols(dta, theme_analysis_data_consumer)
```



# I.Pregled tematskog pejzaža (Potrošačke Teme)



Prvi korak je razumjeti opću strukturu diskursa iz perspektive potrošača. Koje teme dominiraju, a koje su na marginama? Koliko su te teme centralne za članke u kojima se pojavljuju?

### Dinamika glavnih tema

Analiza udjela svake potrošačke teme otkriva da je diskurs dominantno fokusiran na Kamatne stope (INTEREST_RATES) i Regulaciju zaduživanja (LENDING_REGULATIONS). Ove dvije teme čine okosnicu razgovora o HNB-u koji se tiče građana. Teme vezane za Zaštitu potrošača (CONSUMER_PROTECTION) i Interne poslove HNB-a (HNB_INTERNAL_AFFAIRS), poput plaća, također imaju konstantan i zamjetan udio.



```{r}
topic_trends_consumer <- dta_with_consumer_themes %>%
  select(year, INTEREST_RATES:HNB_INTERNAL_AFFAIRS) %>%
  pivot_longer(cols = -year, names_to = "topic", values_to = "count") %>%
  group_by(year, topic) %>%
  summarise(total_mentions = sum(count), .groups = 'drop') %>%
  group_by(year) %>%
  mutate(share = total_mentions / sum(total_mentions)) %>%
  ungroup()

# Priprema podataka za labele
topic_trends_clean <- topic_trends_consumer %>%
  mutate(topic = str_replace_all(topic, "_", " ") %>% str_to_title())
labels_data <- topic_trends_clean %>%
  filter(year == max(year))

# Kreiranje plota
ggplot(topic_trends_clean, aes(x = year, y = share, color = topic, group = topic)) +
  geom_line(linewidth = 1.5) +
  geom_point(size = 3) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_x_continuous(breaks = c(2021, 2022, 2023), expand = expansion(add = c(0, 0.5))) +
  geom_label_repel(
    data = labels_data,
    aes(label = topic),
    nudge_x = 0.2,
    direction = "y",
    hjust = 0,
    segment.color = "grey50",
    size = 4
  ) +
  labs(title = "Promjena zastupljenosti potrošačkih tema",
       x = "Godina", y = "Udio teme u korpusu") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "none")
```



### Intenzitet tema: Što je vijest, a što pozadinski šum?

Nije svako spominjanje teme jednako važno. Ovaj grafikon pokazuje koliko je tema centralna za članak kada se u njemu pojavi. Teme s distribucijom pomaknutom udesno, poput Kamatnih stopa i Regulacije zaduživanja, su one koje, kada se pojave, dominiraju člankom i predstavljaju glavnu vijest. Teme poput Bankovnih naknada češće se spominju usputno, kao kontekst glavne priče.

```{r}
thematic_intensity_data <- dta_with_consumer_themes %>%
  select(starts_with("norm_")) %>%
  pivot_longer(everything(), names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0) %>%
  mutate(topic = str_replace_all(topic, "_", " ") %>% str_to_title())

ggplot(thematic_intensity_data, aes(x = intensity, y = fct_reorder(topic, intensity, .fun = median))) +
  geom_density_ridges(scale = 2, fill = "#0072B2", color = "white", alpha = 0.8) +
  scale_x_log10(breaks = c(1, 10, 100, 1000), labels = c("1", "10", "100", "1000")) +
  theme_minimal(base_size = 14) +
  labs(
    title = "Distribucija intenziteta tema",
    subtitle = "Koliko su teme centralne za članke u kojima se pojavljuju?",
    x = "Intenzitet teme (spominjanja na 1000 riječi, log skala)",
    y = "Tema"
  ) +
  theme(panel.grid.major.y = element_blank())
```



# II.Utjecaj i prijem tema

Nakon što smo mapirali potrošačke teme, istražujemo kako publika reagira na njih. Koje teme potiču najveći angažman?




### Koje teme generiraju najviše interakcija?

Analiza prosječnog broja interakcija po članku otkriva jasan obrazac: teme koje se tiču Internih poslova HNB-a (HNB_INTERNAL_AFFAIRS), prvenstveno plaća dužnosnika, generiraju daleko najveći angažman publike. Slijedi tema Bankovnih naknada (BANK_FEES). Ovo ukazuje da transparentnost troškova i visina naknada služe kao ključni pokretači interakcija u digitalnom prostoru kada je riječ o HNB-u iz perspektive potrošača.

```{r}
engagement_by_topic <- dta_with_consumer_themes %>%
  filter(dominant_topic != "Nema Teme") %>%
  group_by(dominant_topic) %>%
  summarise(
    avg_interactions = mean(INTERACTIONS, na.rm = TRUE),
    total_articles = n()
  ) %>%
  arrange(desc(avg_interactions)) %>%
  mutate(dominant_topic = str_replace_all(dominant_topic, "_", " ") %>% str_to_title())

ggplot(engagement_by_topic, aes(x = avg_interactions, y = reorder(dominant_topic, avg_interactions))) +
  geom_col(fill = "#0072B2", width=0.8) +
  geom_text(aes(label = round(avg_interactions)), hjust = -0.2, size=4) +
  expand_limits(x = max(engagement_by_topic$avg_interactions) * 1.1) +
  theme_minimal(base_size = 14) +
  labs(title = "Koje teme generiraju najviše interakcija?",
       subtitle = "Prosječan broj interakcija po članku za svaku dominantnu temu",
       x = "Prosječne interakcije", y = "Dominantna tema") +
  theme(panel.grid.major.y = element_blank())
```





# III.Akteri i narativni okviri

Tko su glavni protagonisti svake potrošačke teme i kako se teme međusobno povezuju u šire narativne okvire?

### Glavni akteri unutar svake teme

Svaka tematska "priča" ima svoje glavne likove. Analizom najčešće spominjanih osoba unutar svake dominantne potrošačke teme, dobivamo uvid u to tko su nositelji narativa. Očekivano, guverner Vujčić je centralna figura u gotovo svim ključnim temama, posebno onima vezanim za kamatne stope i regulaciju. Politički akteri poput Plenkovića i Milanovića također su istaknuti, potvrđujući isprepletenost monetarne politike i politike.

```{r}
# Identificiramo najčešće dominantne potrošačke teme
top_dominant_consumer_topics <- dta_with_consumer_themes %>%
  filter(dominant_topic != "Nema Teme") %>%
  count(dominant_topic, sort = TRUE) %>%
  slice_head(n = 5) %>%
  pull(dominant_topic)

# Priprema podataka
entities_in_topics <- nlp_results_df %>%
  filter(upos == "PROPN") %>%
  select(doc_id, lemma) %>%
  inner_join(dta_with_consumer_themes %>% select(doc_id, dominant_topic), by = "doc_id") %>%
  filter(dominant_topic %in% top_dominant_consumer_topics) %>%
  filter(!lemma %in% c("hrvatska", "zagreb", "split", "eu", "hnb"))

# Izračun top aktera
top_actors_in_top_topics <- entities_in_topics %>%
  count(dominant_topic, lemma, sort = TRUE) %>%
  group_by(dominant_topic) %>%
  slice_max(order_by = n, n = 10) %>%
  ungroup() %>%
  mutate(dominant_topic = str_replace_all(dominant_topic, "_", " ") %>% str_to_title())

# Vizualizacija
ggplot(top_actors_in_top_topics, aes(x = n, y = reorder_within(lemma, n, dominant_topic), fill = dominant_topic)) +
  geom_col(show.legend = FALSE, width = 0.8) +
  scale_y_reordered() +
  scale_fill_viridis_d() +
  facet_wrap(~ dominant_topic, scales = "free_y", ncol = 1) +  
  labs(
    title = "Ključni akteri unutar Top 5 najzastupljenijih potrošačkih tema",
    subtitle = "Top 10 najčešće spominjanih osoba ili organizacija za svaku temu",
    x = "Ukupan broj spominjanja",
    y = "Akter (lema)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(face = "bold", size = 12, hjust = 0),
    panel.grid.major.y = element_blank()
  )
```



### Mreža narativnih okvira: Kako se teme povezuju?

Teme se rijetko pojavljuju izolirano. One se spajaju u šire narativne okvire. Analizom ko-okurencije tema unutar istih članaka, možemo mapirati te veze. Mreža pokazuje izuzetno snažnu povezanost između Kamatnih stopa (INTEREST_RATES) i Regulacije zaduživanja (LENDING_REGULATIONS), tvoreći dominantan "kreditni" klaster koji je u srcu potrošačkog diskursa. Tema Zaštite potrošača služi kao most, povezujući se i s bankovnim naknadama i s regulacijom zaduživanja.


```{r}
topic_pairs_consumer <- dta_with_consumer_themes %>%
  select(doc_id, starts_with("norm_")) %>%
  pivot_longer(-doc_id, names_to = "topic", values_to = "intensity") %>%
  mutate(topic = str_remove(topic, "norm_")) %>%
  filter(intensity > 0) %>%
  pairwise_cor(item = topic, feature = doc_id, upper = FALSE) %>%
  mutate(item1 = str_replace_all(item1, "_", " ") %>% str_to_title(),
         item2 = str_replace_all(item2, "_", " ") %>% str_to_title())

set.seed(123)
topic_pairs_consumer %>%
  filter(correlation > 0.05) %>% # Smanjen prag za više veza
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(edge_alpha = correlation, edge_width = correlation), color = "lightblue") +
  geom_node_point(color = "darkblue", size = 5) +
  geom_node_text(aes(label = str_wrap(name, 20)), repel = TRUE, size = 4) +
  theme_void() +
  labs(
    title = "Mreža povezanosti potrošačkih tema",
    subtitle = "Koje se teme najčešće pojavljuju zajedno u istim člancima?",
    edge_width = "Snaga veze (korelacija)",
    edge_alpha = ""
  )
```


Zaključak

Ova tematska analiza pokazuje da je digitalni prostor o HNB-u, iz perspektive potrošača, visoko fokusiran i strukturiran oko nekoliko ključnih životnih tema.

    Dominacija kreditnog diskursa: Rasprave o kamatnim stopama i uvjetima zaduživanja čine apsolutni centar razgovora. Ove dvije teme su neraskidivo povezane i predstavljaju glavnu arenu u kojoj se percipira utjecaj HNB-a na svakodnevni život.

    Angažman potaknut transparentnošću: Iako su kamate najčešća tema, interne afere HNB-a (plaće) i bankovne naknade su teme koje izazivaju najviše strasti i interakcija, što ukazuje na visoku osjetljivost javnosti na pitanja transparentnosti i troškova.

    Centralna uloga guvernera: Guverner HNB-a prepoznat je kao ključni akter u svim najvažnijim potrošačkim temama, potvrđujući njegovu ulogu kao primarnog komunikatora i nositelja monetarne politike u očima javnosti.

Razumijevanje strukture, utjecaja i povezanosti ovih tema ključno je za svaku daljnju analizu narativa i sentimenata koji oblikuju javnu percepciju Hrvatske narodne banke.




